/*====================================================*/
/* Ryan Nguyen and Tyler Bishop */
/* ELEC 3040/3050 - Lab 3, Program 1 */
/*====================================================*/
#include "STM32L1xx.h"

int cycles;
int count;
int reversecount;
unsigned char sw1; 
unsigned char sw2; 

void PinSetup () {
	RCC->AHBENR |= 0x01; // Sets up the Inputs
	GPIOA->MODER &= ~(0x0000000C); 

	RCC->AHBENR |= 0x04; // Sets up the LED Outputs
	GPIOC->MODER &= ~(0x000FFFFF); 
	GPIOC->MODER |= (0x00055555); 
	
	NVIC_EnableIRQ (6);
	NVIC_ClearPendingIRQ (6); 
	NVIC_EnableIRQ (7);
	NVIC_ClearPendingIRQ (7); 

	SYSCFG->EXTICR[0] &= 0xFF00;
	SYSCFG->EXTICR[0] |= 0x0000; 

	EXTI->RTSR |=0x0003;
	EXTI->IMR |=0x0003;

	__enable_irq();
}

void EXTI0_IRQHandler () { 
	sw1 = !sw1;
	EXTI->PR |= 0x0001;
}

void EXTI1_IRQHandler () { 
	sw2 = !sw2;
	EXTI->PR |= 0x0002;
}

void delay () {
	int i,j,n;
	for (i=0; i<10; i++) { //outer loop
		for (j=0; j<17500; j++) { //inner loop
		n = j; //dummy operation for single-step test
		} //do nothing
	}
}

void counter(char sw2) {
	if (sw2 == 0) { 
			if (count != 9) { 
				count++; 
			} else {
				count = 0; 
			}
			
			delay(); 
			
			if (reversecount != 0) {
				reversecount--;
			} else {
				reversecount = 9;
			}
		} else {
			if (count != 0) { 
				count--; 
			} else {
				count = 9; 
			}
			
			delay(); 
			
			if (reversecount!= 9) {
				reversecount++;
			} else {
				reversecount = 0;
			}
		}
}

/*------------------------------------------------*/
/* Main program */
/*------------------------------------------------*/
int main(void) {
	
	PinSetup(); 
	cycles = 0; 
	count = 0; 
	reversecount = 0;
	sw1 = 0;
	sw2 = 0;
	
	while (1) {
		
		while (sw1 == 0) {
			cycles++;
		}
		 
		counter(sw2);
		GPIOC->ODR =(reversecount*16)+count;
		delay(); 
		
	}
} 
